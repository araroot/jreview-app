<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Êó•Êú¨Ë™û">

  <link rel="apple-touch-icon" href="icon-180.png">
  <link rel="apple-touch-icon" sizes="180x180" href="icon-180.png">

  <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">

  <link rel="manifest" href="manifest-meg.json">

  <title>Japanese Sentence Review - Meg</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; display: flex; flex-direction: column; color: white; overflow-x: hidden; }
    .header { padding: 20px; text-align: center; background: rgba(0, 0, 0, 0.2); }
    .header h1 { font-size: 24px; margin-bottom: 10px; }
    .stats { display: flex; justify-content: center; gap: 20px; font-size: 14px; opacity: 0.9; }
    .stat-item { display: flex; flex-direction: column; align-items: center; }
    .stat-number { font-size: 24px; font-weight: bold; }

    .main-container { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; position: relative; }
    @media (max-height: 700px) { .main-container { padding: 10px; } }

    .progress-bar { width: 100%; max-width: 420px; height: 8px; background: rgba(255, 255, 255, 0.2); border-radius: 10px; margin-bottom: 30px; overflow: hidden; }
    .progress-fill { height: 100%; background: linear-gradient(90deg, #10b981, #34d399); border-radius: 10px; transition: width 0.2s ease; }

    .card-container { width: 100%; max-width: 420px; height: 440px; position: relative; perspective: 1000px; }
    @media (max-height: 700px) { .card-container { height: 360px; } }

    .flashcard { width: 100%; height: 100%; background: white; border-radius: 20px; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3); display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 26px; cursor: pointer; transition: transform 0.3s ease; position: absolute; touch-action: pan-y; }
    .flashcard.flipped .card-front { display: none; }
    .flashcard.flipped .card-back { display: flex; }
    .card-front, .card-back { width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; position: relative; }
    .card-back { display: none; }

    .delete-btn { position: absolute; top: 15px; right: 15px; background: transparent; color: #9ca3af; border: none; border-radius: 50%; width: 36px; height: 36px; font-size: 18px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease; z-index: 10; opacity: 0.6; }
    .delete-btn:hover { opacity: 1; transform: scale(1.1); }
    .delete-btn:active { transform: scale(0.95); }

    .sentence-front { font-size: 28px; font-weight: 700; color: #111827; line-height: 1.25; text-align: left; width: 100%; max-height: 240px; overflow-y: auto; }
    .meta { font-size: 13px; color: #6b7280; text-align: left; margin-top: 14px; line-height: 1.4; width: 100%; max-height: 90px; overflow-y: auto; }

    .translation { font-size: 16px; color: #111827; text-align: left; width: 100%; line-height: 1.35; max-height: 140px; overflow-y: auto; }
    .targets { margin-top: 12px; width: 100%; max-height: 160px; overflow-y: auto; }
    .target { background: #f3f4f6; border-radius: 10px; padding: 10px; margin-bottom: 8px; }
    .target-word { font-size: 18px; font-weight: 800; color: #3b82f6; }
    .target-reading { font-size: 13px; color: #6b7280; margin-top: 2px; }
    .target-meaning { font-size: 14px; color: #111827; margin-top: 6px; }

    .context-back { margin-top: 12px; padding: 10px; background: #f9fafb; border-radius: 10px; max-width: 100%; width: 100%; max-height: 140px; overflow-y: auto; }
    .context-sentence { font-size: 13px; color: #111827; margin-bottom: 6px; line-height: 1.35; white-space: pre-wrap; }

    .action-buttons { display: flex; gap: 12px; margin-top: 16px; }
    .btn { padding: 14px 20px; border: none; border-radius: 12px; font-size: 16px; font-weight: 700; cursor: pointer; transition: all 0.2s ease; color: white; }
    .btn-hard { background: linear-gradient(135deg, #ef4444, #dc2626); }
    .btn-good { background: linear-gradient(135deg, #f59e0b, #d97706); }
    .btn-easy { background: linear-gradient(135deg, #10b981, #059669); }
    .btn:active { transform: scale(0.97); }

    .completion-screen { display: none; text-align: center; }
    .completion-screen.active { display: flex; flex-direction: column; align-items: center; justify-content: center; }
    .completion-emoji { font-size: 80px; margin-bottom: 20px; }
    .completion-title { font-size: 32px; font-weight: bold; margin-bottom: 10px; }
    .completion-message { font-size: 18px; opacity: 0.9; margin-bottom: 30px; }

    .login-screen { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 16px; }
    .login-btn { padding: 15px 40px; background: white; color: #667eea; border: none; border-radius: 12px; font-size: 18px; font-weight: 700; cursor: pointer; width: 100%; max-width: 420px; }

    .nav-buttons { display: flex; gap: 15px; margin-top: 20px; justify-content: center; }
    .nav-btn { background: rgba(255, 255, 255, 0.1); border: 2px solid rgba(255, 255, 255, 0.3); color: white; padding: 12px 24px; border-radius: 12px; font-size: 18px; cursor: pointer; transition: all 0.2s ease; font-weight: 700; }
    .nav-btn:hover { background: rgba(255, 255, 255, 0.2); border-color: rgba(255, 255, 255, 0.5); }
    .nav-btn:disabled { opacity: 0.3; cursor: not-allowed; }
    .nav-btn:active:not(:disabled) { transform: scale(0.97); }

    .list-item { background: rgba(255,255,255,0.12); border-radius: 12px; padding: 12px; margin-bottom: 10px; width: 100%; }
    .list-meta { font-size: 13px; opacity: 0.9; margin-bottom: 6px; }
    .list-text { font-size: 18px; line-height: 1.35; margin-bottom: 10px; }
    .list-actions { display:flex; gap:10px; }
    .list-btn { padding: 10px 14px; font-size: 14px; border-radius: 12px; border: none; cursor: pointer; font-weight: 700; }
    .list-btn-primary { background: white; color: #667eea; }
    .list-btn-secondary { background: rgba(255,255,255,0.2); color: white; }
  </style>
</head>
<body>
  <div class="header">
    <h1>üìö Japanese Review V49</h1>
    <div class="stats">
      <div class="stat-item"><div class="stat-number" id="dueCount">0</div><div>Due Today</div></div>
      <div class="stat-item"><div class="stat-number" id="reviewedCount">0</div><div>Reviewed</div></div>
      <div class="stat-item"><div class="stat-number" id="streakCount">0</div><div>üî• Streak</div></div>
    </div>
  </div>

  <div class="main-container">
    <div class="login-screen" id="loginScreen">
      <h2>Welcome! üëã</h2>
      <p>Enter your User ID from the extension</p>
      <input type="text" id="userIdInput" placeholder="user_xxxxx" style="padding: 12px; border-radius: 8px; border: 2px solid white; font-size: 16px; width: 250px; margin-bottom: 10px;">
      <p style="margin-top: 10px;">OpenAI API Key (for mining details)</p>
      <input type="password" id="apiKeyInput" placeholder="sk-..." style="padding: 12px; border-radius: 8px; border: 2px solid white; font-size: 16px; width: 250px; margin-bottom: 10px;">
      <button class="login-btn" id="loginBtn">Continue</button>
      <p style="font-size: 12px; opacity: 0.75; margin-top: 8px; text-align:center;">Find your User ID: Click extension icon ‚Üí Copy ID<br>Get API key: <a href="https://platform.openai.com/api-keys" target="_blank" style="color: white;">OpenAI API Keys</a></p>
    </div>

    <div class="login-screen" id="homeScreen" style="display: none; width: 100%;">
      <h2>Sentence Mining ‚õèÔ∏è</h2>
      <p style="margin-bottom: 10px; font-size: 14px; opacity: 0.9; text-align:center;">Review mined sentences and mine new ones from your shows</p>
      <button class="login-btn" id="reviewDueSentences" style="background: linear-gradient(135deg, #10b981, #059669);">üìÖ Review Due (Due: <span id="dueSentenceCount">0</span>)</button>
      <button class="login-btn" id="mineSentencesBtn" style="background: linear-gradient(135deg, #f59e0b, #d97706);">‚õèÔ∏è Mine Sentences (New: <span id="candidateCount">0</span>)</button>
      <button class="login-btn" id="refreshHomeBtn" style="background: rgba(255,255,255,0.2); color: white;">‚Üª Refresh</button>
    </div>

    <div class="login-screen" id="mineScreen" style="display: none; width: 100%; max-width: 520px;">
      <h2>Mine Sentences</h2>
      <p style="margin-bottom: 10px; font-size: 14px; opacity: 0.9; text-align:center;">Pick sentences to add to your deck (AI adds translation + 1‚Äì2 target words)</p>
      <div id="candidateList" style="max-height: 460px; overflow-y: auto; margin-bottom: 12px; width: 100%;"></div>
      <button class="login-btn" id="backHomeBtn" style="background: rgba(255,255,255,0.2); color: white;">‚Üê Back</button>
    </div>

    <div id="reviewScreen" style="display: none; width: 100%;">
      <div class="progress-bar"><div class="progress-fill" id="progressFill" style="width: 0%"></div></div>
      <div class="card-container">
        <div class="flashcard" id="flashcard">
          <div class="card-front">
            <button class="delete-btn" id="deleteBtnFront" title="Delete this sentence">üóëÔ∏è</button>
            <div class="sentence-front" id="sentenceFront"></div>
            <div class="meta" id="sentenceMeta"></div>
          </div>
          <div class="card-back">
            <button class="delete-btn" id="deleteBtnBack" title="Delete this sentence">üóëÔ∏è</button>
            <div class="translation" id="translationDisplay"></div>
            <div class="targets" id="targetsContainer"></div>
            <div class="context-back" id="contextBack">
              <div class="context-sentence" id="contextSentenceBack"></div>
            </div>
            <div class="action-buttons">
              <button class="btn btn-hard" id="btnHard">üîÑ Hard</button>
              <button class="btn btn-good" id="btnGood">‚úì Good</button>
              <button class="btn btn-easy" id="btnEasy">‚úì‚úì Easy</button>
            </div>
          </div>
        </div>
      </div>
      <div class="nav-buttons">
        <button class="nav-btn" id="btnPrevious">‚Üê Previous</button>
        <button class="nav-btn" id="btnNext">Next ‚Üí</button>
      </div>
      <div class="swipe-indicator" style="width: 100%; max-width: 420px; margin-top: 14px; font-size: 12px; opacity: 0.7; display:flex; justify-content: space-between;">
        <span>‚Üê Hard (1 day)</span><span>Good (3 days)</span><span>Easy (7 days) ‚Üí</span>
      </div>
    </div>

    <div class="completion-screen" id="completionScreen">
      <div class="completion-emoji">üéâ</div>
      <div class="completion-title">Session Complete!</div>
      <div class="completion-message" style="font-size: 16px; margin-bottom: 20px;">You reviewed <span id="summaryTotal">0</span> sentences</div>
      <div style="display: flex; gap: 20px; justify-content: center; margin-bottom: 25px; font-size: 14px;">
        <div style="text-align: center;"><div style="font-size: 28px; font-weight: bold; color: #ef4444;" id="summaryHard">0</div><div style="opacity: 0.8;">üîÑ Hard</div></div>
        <div style="text-align: center;"><div style="font-size: 28px; font-weight: bold; color: #10b981;" id="summaryGood">0</div><div style="opacity: 0.8;">‚úì Good</div></div>
        <div style="text-align: center;"><div style="font-size: 28px; font-weight: bold; color: #3b82f6;" id="summaryEasy">0</div><div style="opacity: 0.8;">‚úì‚úì Easy</div></div>
        <div style="text-align: center; display:none;" id="summaryDeletedContainer"><div style="font-size: 28px; font-weight: bold; color: #9ca3af;" id="summaryDeleted">0</div><div style="opacity: 0.8;">üóëÔ∏è Deleted</div></div>
      </div>
      <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px; font-size: 13px; line-height: 1.6; margin-bottom: 20px; max-width: 420px; text-align:left;">
        <strong>‚õèÔ∏è Sentence mining:</strong><br>
        ‚Ä¢ Sentences are collected while you watch.<br>
        ‚Ä¢ You mine the best ones into your deck.<br>
        ‚Ä¢ AI fills translation + 1‚Äì2 target words.
      </div>
      <button type="button" class="btn btn-good" id="continueBtn" onclick="window.handleContinue && window.handleContinue()" style="padding: 15px 40px; cursor: pointer; -webkit-tap-highlight-color: rgba(0,0,0,0.2);">Continue ‚Üí</button>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

  <script>
    // Same logic as main review app (sentence mining)
    const firebaseConfig = {
      apiKey: "AIzaSyDQgZ4XKuEbQ6mincj6R8bX6gBH_CUETUY",
      authDomain: "japanese-learning-app-dc19d.firebaseapp.com",
      databaseURL: "https://japanese-learning-app-dc19d-default-rtdb.firebaseio.com",
      projectId: "japanese-learning-app-dc19d",
      storageBucket: "japanese-learning-app-dc19d.firebasestorage.app",
      messagingSenderId: "68430245068",
      appId: "1:68430245068:web:c40f7e0a6717f054b4a669"
    };

    let app;
    function initFirebase() {
      try { app = firebase.initializeApp(firebaseConfig); return true; }
      catch (e) { console.error(e); alert('Firebase init failed'); return false; }
    }

    let currentUserId = null;
    let currentSentences = [];
    let currentIndex = 0;
    let isFlipped = false;
    let reviewedToday = 0;
    let sessionStats = { hard: 0, good: 0, easy: 0, deleted: 0, total: 0 };

    function getCookie(name) {
      const v = `; ${document.cookie}`;
      const p = v.split(`; ${name}=`);
      if (p.length === 2) return decodeURIComponent(p.pop().split(';').shift());
      return null;
    }

    function switchScreen(screenId) {
      const screens = ['loginScreen', 'homeScreen', 'mineScreen', 'reviewScreen', 'completionScreen'];
      screens.forEach(id => {
        const el = document.getElementById(id);
        if (!el) return;
        el.style.display = 'none';
        el.classList.remove('active');
      });

      const target = document.getElementById(screenId);
      if (!target) return;

      if (screenId === 'completionScreen') {
        target.style.display = 'flex';
        target.classList.add('active');
      } else if (screenId === 'reviewScreen') {
        target.style.display = 'block';
      } else {
        target.style.display = 'flex';
      }
    }

    function fbUrl(path) { return `${firebaseConfig.databaseURL}${path}.json`; }

    async function fbGet(path) {
      const res = await fetch(fbUrl(path));
      if (!res.ok) throw new Error(`Firebase GET failed: ${res.status}`);
      return await res.json();
    }

    async function fbPut(path, data) {
      const res = await fetch(fbUrl(path), {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });
      if (!res.ok) throw new Error(`Firebase PUT failed: ${res.status}`);
      return await res.json();
    }

    async function fbPatch(path, data) {
      const res = await fetch(fbUrl(path), {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });
      if (!res.ok) throw new Error(`Firebase PATCH failed: ${res.status}`);
      return await res.json();
    }

    async function fbDelete(path) {
      const res = await fetch(fbUrl(path), { method: 'DELETE' });
      if (!res.ok) throw new Error(`Firebase DELETE failed: ${res.status}`);
      return true;
    }

    function showLabel(showObj) {
      if (!showObj || !showObj.name) return '';
      const s = (showObj.season !== null && showObj.season !== undefined) ? `S${showObj.season}` : '';
      const e = (showObj.episode !== null && showObj.episode !== undefined) ? `E${showObj.episode}` : '';
      return `${showObj.name} ${s}${e}`.trim();
    }

    async function loadHome() {
      const now = Date.now();
      const sentences = await fbGet(`/users/${currentUserId}/sentences`) || {};
      const list = Object.values(sentences);
      const due = list.filter(s => !s.mastered && (s.nextReview || 0) <= now).length;

      document.getElementById('dueSentenceCount').textContent = String(due);
      document.getElementById('dueCount').textContent = String(due);

      const candidates = await fbGet(`/users/${currentUserId}/sentenceCandidates`) || {};
      const candList = Object.values(candidates).filter(c => (c.status || 'new') === 'new');
      document.getElementById('candidateCount').textContent = String(candList.length);
    }

    function renderTargets(targets) {
      const el = document.getElementById('targetsContainer');
      el.innerHTML = '';
      if (!targets || targets.length === 0) return;

      for (const t of targets) {
        const row = document.createElement('div');
        row.className = 'target';
        row.innerHTML = `
          <div class="target-word">${t.word || ''}</div>
          <div class="target-reading">${t.reading || ''}</div>
          <div class="target-meaning">${t.meaning || ''}</div>
        `;
        el.appendChild(row);
      }
    }

    function showCurrentCard() {
      if (currentIndex >= currentSentences.length) {
        switchScreen('completionScreen');
        document.getElementById('summaryTotal').textContent = String(sessionStats.total);
        document.getElementById('summaryHard').textContent = String(sessionStats.hard);
        document.getElementById('summaryGood').textContent = String(sessionStats.good);
        document.getElementById('summaryEasy').textContent = String(sessionStats.easy);

        if (sessionStats.deleted > 0) {
          document.getElementById('summaryDeletedContainer').style.display = 'block';
          document.getElementById('summaryDeleted').textContent = String(sessionStats.deleted);
        } else {
          document.getElementById('summaryDeletedContainer').style.display = 'none';
        }

        void updateStats();
        return;
      }

      const s = currentSentences[currentIndex];
      const progress = ((currentIndex + 1) / currentSentences.length) * 100;
      document.getElementById('progressFill').style.width = progress + '%';

      document.getElementById('btnPrevious').disabled = (currentIndex === 0);
      document.getElementById('btnNext').disabled = (currentIndex === currentSentences.length - 1);

      document.getElementById('sentenceFront').textContent = s.text || '';
      const meta = [showLabel(s.show), s.platform].filter(Boolean).join(' ¬∑ ');
      document.getElementById('sentenceMeta').textContent = meta;

      document.getElementById('translationDisplay').textContent = s.translation || '';
      renderTargets(s.targets || []);

      const ctx = [s.before, s.text, s.after].filter(Boolean).join('\n');
      const ctxEl = document.getElementById('contextBack');
      document.getElementById('contextSentenceBack').textContent = ctx;
      ctxEl.style.display = ctx ? 'block' : 'none';

      document.getElementById('flashcard').classList.remove('flipped');
      isFlipped = false;
    }

    async function loadDueSentences(limit = 25) {
      const now = Date.now();
      const sentencesObj = await fbGet(`/users/${currentUserId}/sentences`) || {};

      currentSentences = Object.values(sentencesObj)
        .filter(s => !s.mastered && (s.nextReview || 0) <= now)
        .sort((a, b) => (a.nextReview || 0) - (b.nextReview || 0))
        .slice(0, limit);

      if (currentSentences.length === 0) {
        switchScreen('completionScreen');
        document.querySelector('.completion-message').textContent = 'No sentences due right now.';
        document.getElementById('summaryTotal').textContent = '0';
        document.getElementById('summaryHard').textContent = '0';
        document.getElementById('summaryGood').textContent = '0';
        document.getElementById('summaryEasy').textContent = '0';
        return;
      }

      sessionStats = { hard: 0, good: 0, easy: 0, deleted: 0, total: 0 };
      currentIndex = 0;
      reviewedToday = 0;
      document.getElementById('reviewedCount').textContent = '0';

      switchScreen('reviewScreen');
      showCurrentCard();
    }

    async function enrichCandidateWithAI(candidate) {
      const apiKey = localStorage.getItem('openaiApiKey');
      if (!apiKey) throw new Error('OpenAI API key not found');

      const prompt = `You are a Japanese teacher helping with AJATT sentence mining.\n\nSentence:\n${candidate.text}\n\nContext (previous line):\n${candidate.before || ''}\n\nContext (next line):\n${candidate.after || ''}\n\nTask:\n1) Give a natural English translation of the sentence.\n2) Pick up to 2 target words/expressions from the sentence that are worth learning (prefer difficult/high-value). Ignore names.\n3) For each target, provide reading in hiragana and a concise English meaning.\n\nReturn ONLY JSON in this format:\n{\n  \"translation\": \"...\",\n  \"targets\": [\n    {\"word\":\"...\",\"reading\":\"...\",\"meaning\":\"...\"}\n  ]\n}`;

      const res = await fetch('https://api.openai.com/v1/chat/completions', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
        body: JSON.stringify({
          model: 'gpt-4o-mini',
          messages: [{ role: 'user', content: prompt }],
          temperature: 0.3,
          max_tokens: 500
        })
      });

      if (!res.ok) throw new Error(`OpenAI API error: ${res.status}`);
      const data = await res.json();
      let text = (data.choices?.[0]?.message?.content || '').trim();

      if (text.startsWith('```json')) text = text.replace(/^```json\s*/i, '').replace(/```$/i, '').trim();
      else if (text.startsWith('```')) text = text.replace(/^```\s*/i, '').replace(/```$/i, '').trim();

      const parsed = JSON.parse(text);
      return {
        translation: parsed.translation || '',
        targets: Array.isArray(parsed.targets) ? parsed.targets.slice(0, 2) : []
      };
    }

    async function mineCandidateById(id) {
      const existingSentence = await fbGet(`/users/${currentUserId}/sentences/${id}`);
      if (existingSentence) {
        await fbPatch(`/users/${currentUserId}/sentenceCandidates/${id}`, { status: 'mined', minedAt: Date.now() });
        return;
      }

      const candidate = await fbGet(`/users/${currentUserId}/sentenceCandidates/${id}`);
      if (!candidate) throw new Error('Candidate not found');

      const enrich = await enrichCandidateWithAI(candidate);
      const now = Date.now();

      const sentence = {
        id,
        text: candidate.text,
        before: candidate.before || '',
        after: candidate.after || '',
        show: candidate.show || null,
        platform: candidate.platform || 'unknown',
        occurrences: candidate.occurrences || 1,
        translation: enrich.translation,
        targets: enrich.targets,
        createdAt: now,
        lastReviewed: null,
        nextReview: now,
        reviewCount: 0,
        difficulty: 'new',
        mastered: false
      };

      await fbPut(`/users/${currentUserId}/sentences/${id}`, sentence);
      await fbPatch(`/users/${currentUserId}/sentenceCandidates/${id}`, { status: 'mined', minedAt: now });
    }

    async function loadCandidates() {
      const candidatesObj = await fbGet(`/users/${currentUserId}/sentenceCandidates`) || {};
      const candidates = Object.values(candidatesObj)
        .sort((a, b) => (b.lastSeenAt || 0) - (a.lastSeenAt || 0))
        .slice(0, 80);

      const listEl = document.getElementById('candidateList');
      listEl.innerHTML = '';

      if (candidates.length === 0) {
        listEl.innerHTML = '<p style="color: white; text-align: center; padding: 20px;">No candidates yet. Watch a show to collect sentences.</p>';
        return;
      }

      for (const c of candidates) {
        const item = document.createElement('div');
        item.className = 'list-item';

        const meta = [showLabel(c.show), `${c.occurrences || 1}√ó`, c.status || 'new'].filter(Boolean).join(' ¬∑ ');

        item.innerHTML = `
          <div class="list-meta">${meta}</div>
          <div class="list-text">${c.text}</div>
          <div class="list-actions">
            <button class="list-btn list-btn-primary" data-action="mine" data-id="${c.id}">Mine</button>
            <button class="list-btn list-btn-secondary" data-action="skip" data-id="${c.id}">Skip</button>
          </div>
        `;

        listEl.appendChild(item);
      }

      listEl.querySelectorAll('button[data-action="mine"]').forEach(btn => {
        btn.addEventListener('click', async () => {
          const id = btn.getAttribute('data-id');
          btn.textContent = 'Mining...';
          btn.disabled = true;
          try {
            await mineCandidateById(id);
            btn.textContent = 'Mined ‚úì';
            void loadHome();
          } catch (e) {
            console.error(e);
            btn.textContent = 'Mine (failed)';
            btn.disabled = false;
            alert('Failed to mine sentence: ' + e.message);
          }
        });
      });

      listEl.querySelectorAll('button[data-action="skip"]').forEach(btn => {
        btn.addEventListener('click', async () => {
          const id = btn.getAttribute('data-id');
          btn.textContent = 'Skipping...';
          btn.disabled = true;
          try {
            await fbPatch(`/users/${currentUserId}/sentenceCandidates/${id}`, { status: 'skipped', skippedAt: Date.now() });
            btn.textContent = 'Skipped';
            btn.closest('.list-item').style.opacity = '0.5';
            void loadHome();
          } catch (e) {
            console.error(e);
            btn.textContent = 'Skip (failed)';
            btn.disabled = false;
          }
        });
      });
    }

    async function deleteCurrentSentence() {
      const s = currentSentences[currentIndex];
      try {
        await fbPut(`/users/${currentUserId}/deletedSentences/${s.id}`, { id: s.id, text: s.text, deletedAt: Date.now() });
        await fbDelete(`/users/${currentUserId}/sentences/${s.id}`);

        currentSentences.splice(currentIndex, 1);
        sessionStats.deleted++; sessionStats.total++;

        if (currentSentences.length === 0) {
          switchScreen('completionScreen');
          document.querySelector('.completion-message').textContent = 'All done! Last sentence deleted.';
        } else {
          if (currentIndex >= currentSentences.length) currentIndex = currentSentences.length - 1;
          showCurrentCard();
        }
      } catch (e) {
        console.error(e);
        alert('Failed to delete sentence');
      }
    }

    async function reviewSentence(difficulty) {
      const s = currentSentences[currentIndex];
      const now = Date.now();
      const intervals = { hard: 1, good: 3, easy: 7 };
      const nextReview = now + (intervals[difficulty] * 24 * 60 * 60 * 1000);

      s.lastReviewed = now;
      s.reviewCount = (s.reviewCount || 0) + 1;
      s.difficulty = difficulty;
      s.nextReview = nextReview;
      if (s.reviewCount >= 7 && (difficulty === 'good' || difficulty === 'easy')) s.mastered = true;

      try {
        await fbPatch(`/users/${currentUserId}/sentences/${s.id}`, {
          lastReviewed: s.lastReviewed,
          reviewCount: s.reviewCount,
          difficulty: s.difficulty,
          nextReview: s.nextReview,
          mastered: s.mastered
        });
      } catch (e) {
        console.error(e);
      }

      sessionStats[difficulty]++; sessionStats.total++; reviewedToday++;
      document.getElementById('reviewedCount').textContent = String(reviewedToday);

      currentIndex++;
      showCurrentCard();
    }

    async function updateStats() {
      try {
        await fbPatch(`/users/${currentUserId}/stats`, { reviewedToday, lastReviewDate: Date.now() });
      } catch (e) {}
    }

    document.getElementById('flashcard').addEventListener('click', function(e) {
      if (e.target.classList.contains('delete-btn') || e.target.closest('.delete-btn')) return;
      if (!isFlipped) { this.classList.add('flipped'); isFlipped = true; }
    });

    document.getElementById('deleteBtnFront').addEventListener('click', (e) => { e.stopPropagation(); void deleteCurrentSentence(); });
    document.getElementById('deleteBtnBack').addEventListener('click', (e) => { e.stopPropagation(); void deleteCurrentSentence(); });

    document.getElementById('btnPrevious').addEventListener('click', () => { if (currentIndex > 0) { currentIndex--; showCurrentCard(); } });
    document.getElementById('btnNext').addEventListener('click', () => { if (currentIndex < currentSentences.length - 1) { currentIndex++; showCurrentCard(); } });

    let startX = 0;
    let startY = 0;
    document.getElementById('flashcard').addEventListener('touchstart', (e) => {
      startX = e.touches[0].clientX;
      startY = e.touches[0].clientY;
    });

    document.getElementById('flashcard').addEventListener('touchend', (e) => {
      const endX = e.changedTouches[0].clientX;
      const endY = e.changedTouches[0].clientY;
      const diffX = startX - endX;
      const diffY = startY - endY;
      if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > 50 && isFlipped) {
        if (diffX > 0) void reviewSentence('easy');
        else void reviewSentence('hard');
      }
    });

    document.getElementById('btnHard').addEventListener('click', () => void reviewSentence('hard'));
    document.getElementById('btnGood').addEventListener('click', () => void reviewSentence('good'));
    document.getElementById('btnEasy').addEventListener('click', () => void reviewSentence('easy'));

    document.getElementById('reviewDueSentences').addEventListener('click', async () => {
      try { await loadDueSentences(25); }
      catch (e) { alert('Failed to load due sentences: ' + e.message); }
    });

    document.getElementById('mineSentencesBtn').addEventListener('click', async () => {
      switchScreen('mineScreen');
      try { await loadCandidates(); }
      catch (e) { alert('Failed to load candidates: ' + e.message); }
    });

    document.getElementById('backHomeBtn').addEventListener('click', async () => {
      switchScreen('homeScreen');
      try { await loadHome(); } catch (e) {}
    });

    document.getElementById('refreshHomeBtn').addEventListener('click', async () => {
      try { await loadHome(); }
      catch (e) { alert('Refresh failed: ' + e.message); }
    });

    document.getElementById('loginBtn').addEventListener('click', async () => {
      const userId = document.getElementById('userIdInput').value.trim();
      const apiKey = document.getElementById('apiKeyInput').value.trim();
      if (!userId || !apiKey) { alert('Please enter User ID and API Key'); return; }

      currentUserId = userId;
      localStorage.setItem('savedUserId', userId);
      localStorage.setItem('openaiApiKey', apiKey);

      switchScreen('homeScreen');
      await loadHome();
    });

    window.handleContinue = function() { switchScreen('homeScreen'); void loadHome(); };

    if (initFirebase()) {
      const u = localStorage.getItem('savedUserId') || getCookie('savedUserId');
      const k = localStorage.getItem('openaiApiKey') || getCookie('openaiApiKey');
      if (u) document.getElementById('userIdInput').value = u;
      if (k) document.getElementById('apiKeyInput').value = k;
      if (u && k) {
        currentUserId = u;
        switchScreen('homeScreen');
        void loadHome();
      } else {
        switchScreen('loginScreen');
      }
    }
  </script>
</body>
</html>
